{% extends 'dashboard/base.html' %}
{% load static %}
{% block content %}
{% include 'dashboard/toast_notification.html' %}

<!-- ============================
     Responsive styles
     ============================ -->
<style>
  /* Responsive container adjustments */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Make sure top action area stacks on small screens */
  @media (max-width: 992px) {
    .pd-20.d-flex {
      flex-direction: column;
      align-items: flex-start !important;
    }
    .pd-20 .btn {
      margin-top: 10px;
      width: 100%;
    }
  }

  /* For small screens, allow horizontal table scroll and stack form rows */
  @media (max-width: 768px) {
    table.data-table {
      width: 100%;
      min-width: 800px; /* will allow horizontal scroll for many columns */
    }

    .modal-dialog {
      max-width: 95%;
      margin: 1.75rem auto;
    }

    .form-row {
      display: flex;
      flex-direction: column;
    }

    .form-row .form-group {
      width: 100% !important;
      padding-right: 0;
      padding-left: 0;
    }

    .modal-footer .btn {
      width: 100%;
      margin-top: 8px;
    }

    .card-box .pd-20 {
      padding-bottom: 10px;
    }
  }

  /* Extra small screens */
  @media (max-width: 576px) {
    .modal-title {
      font-size: 16px;
    }
    .card-box h4 {
      font-size: 18px;
    }
    .dropdown .btn {
      font-size: 14px;
    }
  }

  /* Misc */
  .custom-ajax-alert {
    margin-bottom: 10px;
  }

  /* Thumbnail preview small rounding */
  .thumbnail-small {
    border-radius: 6px;
    max-width: 100px;
    max-height: 100px;
  }

  .videos-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap;
    width: 100%;
  }
  @media (max-width: 768px) {
    .videos-header-row {
      flex-wrap: nowrap;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }
    .videos-header-row h4 {
      font-size: 18px;
      margin-bottom: 0;
    }
    .videos-header-row .btn {
      margin-top: 0;
      width: auto;
      min-width: 100px;
      font-size: 15px;
    }
  }
</style>

<!-- ============================
     Main Videos Card
     ============================ -->
<div class="card-box mb-30">
  <div class="pd-20 videos-header-row">
    <h4 class="text-blue h4">Videos</h4>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addVideoModal">
      <i class="fa fa-plus"></i> Add Video
    </button>
  </div>
  
  <div class="pb-20 table-responsive">
    <table class="data-table table stripe hover nowrap">
      <thead>
        <tr>
          <th>Serial Number</th>
          <th>Lesson</th>
          <th>Title</th>
          <th>Time Duration</th>
          <th>Preview</th>
          <th>Resources</th>
          <th class="datatable-nosort">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for video in videos %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>
            {% if video.lesson %}
              {{ video.lesson.name }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if video.youtube_link %}
              <a href="{{ video.youtube_link }}" target="_blank">{{ video.title|truncatechars:20 }}</a>
            {% else %}
              {{ video.title|truncatechars:20 }}
            {% endif %}
          </td>
          <td>{{ video.time_duration }} min</td>
          <td>{% if video.preview %} ✅ {% else %} ❌ {% endif %}</td>
          <td>
            {% if video.resources %}
              <a href="{{ video.resources.url }}" target="_blank">View</a>
            {% else %} - {% endif %}
          </td>
          <td>
            <div class="dropdown">
              <a
                class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle"
                href="#"
                role="button"
                data-toggle="dropdown"
              >
                <i class="dw dw-more"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#viewVideoModal{{video.id}}">
                  <i class="dw dw-eye"></i> View
                </a>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#editVideoModal{{video.id}}">
                  <i class="dw dw-edit2"></i> Edit
                </a>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#deleteVideoModal{{video.id}}">
                  <i class="dw dw-delete-3"></i> Delete
                </a>
              </div>
            </div>

            <!-- =========================
                 View Video Modal
                 ========================= -->
            <div class="modal fade" id="viewVideoModal{{video.id}}" tabindex="-1" role="dialog" aria-labelledby="viewVideoModalLabel{{video.id}}" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="viewVideoModalLabel{{video.id}}">Video Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-6 col-12 mb-2"><strong>Serial Number:</strong> {{ video.serial_number }}</div>
                      <div class="col-md-6 col-12 mb-2"><strong>Course:</strong> {% if video.course %}{{ video.course.title }}{% else %}-{% endif %}</div>
                      <div class="col-md-6 col-12 mb-2"><strong>Lesson:</strong> {% if video.lesson %}{{ video.lesson.name }}{% else %}-{% endif %}</div>
                      <div class="col-md-6 col-12 mb-2"><strong>Title:</strong> {{ video.title }}</div>
                      <div class="col-md-6 col-12 mb-2"><strong>Time Duration:</strong> {{ video.time_duration }} min</div>
                      <div class="col-md-6 col-12 mb-2"><strong>Preview:</strong> {% if video.preview %}Yes{% else %}No{% endif %}</div>
                      <div class="col-12 mb-2">
                        <strong>Thumbnail:</strong><br>
                        {% if video.thumbnail %}
                          <img src="{{ video.thumbnail.url }}" alt="Thumbnail" class="thumbnail-small img-fluid">
                        {% else %}
                          No Image
                        {% endif %}
                      </div>
                      <div class="col-12 mb-2">
                        <strong>Youtube Link:</strong>
                        {% if video.youtube_link %}
                          <a href="{{ video.youtube_link }}" target="_blank">{{ video.youtube_link }}</a>
                        {% else %}
                          -
                        {% endif %}
                      </div>
                      <div class="col-12 mb-2"><strong>Description:</strong> {{ video.description|default:"-" }}</div>
                      <div class="col-12 mb-2">
                        <strong>Resources:</strong>
                        {% if video.resources %}
                          <a href="{{ video.resources.url }}" download>Download</a>
                        {% else %}-{% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- /View Video Modal -->

            <!-- =========================
                 Edit Video Modal
                 ========================= -->
            <div class="modal fade" id="editVideoModal{{video.id}}" tabindex="-1" role="dialog" aria-labelledby="editVideoModalLabel{{video.id}}" aria-hidden="true">
              <div class="modal-dialog modal-lg" role="document">
                <form method="post" action="{% url 'edit_video' %}" enctype="multipart/form-data">
                  {% csrf_token %}
                  <input type="hidden" name="id" value="{{video.id}}">
                  <div class="modal-content">
                    <div class="modal-header text-dark">
                      <h5 class="modal-title" id="editVideoModalLabel{{video.id}}">
                        <i class="dw dw-edit2"></i> Edit Video
                      </h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <!-- Alert placeholder for this edit modal -->
                    <div id="editVideoModalAlert{{video.id}}"></div>

                    <div class="modal-body">
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="serial_number{{video.id}}">Serial Number</label>
                          <input type="number" class="form-control" id="serial_number{{video.id}}" name="serial_number" value="{{video.serial_number}}">
                        </div>
                        <div class="form-group col-md-6">
                          <label for="course{{video.id}}">Course</label>
                          <select class="form-control" id="course{{video.id}}" name="course" required>
                            <option value="">Select Course</option>
                            {% for course in courses %}
                              <option value="{{ course.id }}" {% if video.course and video.course.id == course.id %}selected{% endif %}>{{ course.title }}</option>
                            {% endfor %}
                          </select>
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <div class="d-flex align-items-center">
                            <label for="lesson{{video.id}}" class="mb-0 mr-2">Lesson</label>
                            <button type="button"
                                    class="btn btn-link p-0 ml-2"
                                    data-toggle="modal"
                                    data-target="#addLessonModalAddVideo"
                                    data-edit-modal-id="{{video.id}}"
                                    data-lesson-select-id="lesson{{video.id}}"
                                    style="background: none !important; box-shadow: none;"
                                    tabindex="0">
                              <i class="fa fa-plus"></i> Add Lesson
                            </button>
                          </div>
                          <div class="input-group">
                            <select class="form-control" id="lesson{{video.id}}" name="lesson" required>
                              <option value="">Select Lesson</option>
                              {% for lesson in lessons %}
                                <option value="{{ lesson.id }}" data-course-id="{{ lesson.course.id }}" {% if video.lesson and video.lesson.id == lesson.id %}selected{% endif %}>{{ lesson.name }}</option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>

                        <div class="form-group col-md-6">
                          <label for="title{{video.id}}">Title</label>
                          <input type="text" class="form-control" id="title{{video.id}}" name="title" value="{{video.title}}" required>
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="youtube_link{{video.id}}">Youtube Link</label>
                          <input type="text" class="form-control" id="youtube_link{{video.id}}" name="youtube_link" value="{{video.youtube_link}}">
                        </div>
                        <div class="form-group col-md-6">
                          <label for="time_duration{{video.id}}">Time Duration (min)</label>
                          <input type="number" class="form-control" id="time_duration{{video.id}}" name="time_duration" value="{{video.time_duration}}">
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="preview{{video.id}}">Preview</label>
                          <select class="form-control" id="preview{{video.id}}" name="preview">
                            <option value="True" {% if video.preview %}selected{% endif %}>Yes</option>
                            <option value="False" {% if not video.preview %}selected{% endif %}>No</option>
                          </select>
                        </div> 
                        <div class="form-group col-md-6">
                          <label for="resources{{video.id}}">Resources</label>
                          <input type="file" class="form-control" id="resources{{video.id}}" name="resources">
                          {% if video.resources %}
                            <small class="form-text text-muted">Current: <a href="{{ video.resources.url }}" target="_blank">{{ video.resources.name }}</a></small>
                          {% endif %}
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="thumbnail{{video.id}}">Thumbnail</label>
                          <input type="file" class="form-control" id="thumbnail{{video.id}}" name="thumbnail" accept="image/*">
                          <div class="row mt-2">
                            <div class="col-6">
                              <small class="text-muted">Current:</small>
                              <div class="mt-1">
                                <img id="thumbnailPreview{{video.id}}" src="{% if video.thumbnail %}{{ video.thumbnail.url }}{% endif %}" alt="Thumbnail" style="max-width: 100px; max-height: 100px; {% if not video.thumbnail %}display:none;{% endif %}">
                                {% if not video.thumbnail %}<small class="text-muted">No thumbnail</small>{% endif %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group">
                        <label for="description{{video.id}}">Description</label>
                        <textarea class="form-control" id="description{{video.id}}" name="description" rows="3">{{video.description}}</textarea>
                      </div>
                    </div>

                    <div class="modal-footer bg-light">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="dw dw-cross"></i> Close
                      </button>
                      <button type="submit" class="btn btn-primary">
                        <i class="dw dw-edit2"></i> Save Changes
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <!-- /Edit Video Modal -->

            <!-- =========================
                 Delete Video Modal
                 ========================= -->
            <div class="modal fade" id="deleteVideoModal{{video.id}}" tabindex="-1" role="dialog" aria-labelledby="deleteVideoModalLabel{{video.id}}" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <form method="post" action="{% url 'delete_video' %}">
                  {% csrf_token %}
                  <input type="hidden" name="id" value="{{video.id}}">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteVideoModalLabel{{video.id}}">Delete Video</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <p>Are you sure you want to delete the video "<strong>{{ video.title }}</strong>"?</p>
                      <p class="text-danger"><small>This action cannot be undone.</small></p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-danger">
                        <i class="dw dw-delete-3"></i> Delete
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <!-- /Delete Video Modal -->

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- =========================
     Add Video Modal
     ========================= -->
<div class="modal fade" id="addVideoModal" tabindex="-1" role="dialog" aria-labelledby="addVideoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <form method="post" action="{% url 'add_video' %}" enctype="multipart/form-data" id="addVideoForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header text-dark">
          <h5 class="modal-title" id="addVideoModalLabel">
            <i class="fa fa-plus"></i> Add Video
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <!-- Alert placeholder for Add Video (populated by AJAX add-lesson when needed) -->
        <div id="addVideoModalAlert"></div>

        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="add_serial_number">Serial Number</label>
              <input type="number" class="form-control" id="add_serial_number" name="serial_number" min="1">
            </div>
            <div class="form-group col-md-6">
              <label for="add_course">Course</label>
              <select class="form-control" id="add_course" name="course" required>
                <option value="">Select Course</option>
                {% for course in courses %}
                  <option value="{{ course.id }}">{{ course.title }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <div class="d-flex align-items-center">
                <label for="add_lesson" class="mb-0 mr-2">Lesson</label>
                <button type="button"
                        class="btn btn-link p-0 ml-2"
                        data-toggle="modal"
                        data-target="#addLessonModalAddVideo"
                        style="background: none !important; box-shadow: none;"
                        tabindex="0">
                  <i class="fa fa-plus"></i> Add Lesson
                </button>
              </div>
              <div class="input-group">
                <select class="form-control" id="add_lesson" name="lesson" required>
                  <option value="">Select Lesson</option>
                  {% for lesson in lessons %}
                    <option value="{{ lesson.id }}" data-course-id="{{ lesson.course.id }}">{{ lesson.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group col-md-6">
              <label for="add_title">Title</label>
              <input type="text" class="form-control" id="add_title" name="title" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="add_youtube_link">Youtube Link</label>
              <input type="url" class="form-control" id="add_youtube_link" name="youtube_link" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group col-md-6">
              <label for="add_time_duration">Time Duration (min)</label>
              <input type="number" class="form-control" id="add_time_duration" name="time_duration" min="1">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="add_preview">Preview</label>
              <select class="form-control" id="add_preview" name="preview">
                <option value="False">No</option>
                <option value="True">Yes</option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="add_resources">Resources</label>
              <input type="file" class="form-control" id="add_resources" name="resources">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="add_thumbnail">Thumbnail</label>
              <input type="file" class="form-control" id="add_thumbnail" name="thumbnail" accept="image/*">
              <div class="mt-2">
                <img id="addThumbnailPreview" src="" alt="Thumbnail Preview" class="thumbnail-small" style="display:none;">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="add_description">Description</label>
            <textarea class="form-control" id="add_description" name="description" rows="3" placeholder="Enter video description..."></textarea>
          </div>
        </div>

        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="dw dw-cross"></i> Close
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-plus"></i> Add Video
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- /Add Video Modal -->

<!-- =========================
     Add Lesson Modal (used by both Add Video & Edit Video)
     ========================= -->
<div class="modal fade" id="addLessonModalAddVideo" tabindex="-1" role="dialog" aria-labelledby="addLessonModalAddVideoLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form method="post" action="{% url 'add_lesson' %}" class="ajax-add-lesson-form" data-target-lesson-select-id="add_lesson">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addLessonModalAddVideoLabel">Add New Lesson</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="courseSelectAddVideo">Course</label>
            <select class="form-control" id="courseSelectAddVideo" name="course_id" required>
              <option value="">Select Course</option>
              {% for course in courses %}
                <option value="{{ course.id }}">{{ course.title }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="lessonNameAddVideo">Lesson Name</label>
            <input type="text" class="form-control" id="lessonNameAddVideo" name="lesson_name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fa fa-plus"></i> Add Lesson
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- /Add Lesson Modal -->

<!-- =========================
     AJAX & UI Scripts
     ========================= -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Track which edit modal triggered the Add Lesson modal
    let lastEditModalId = null;

    // When Add Lesson is opened from Edit Video modal, store the video id and lesson select id
    document.querySelectorAll('[data-target="#addLessonModalAddVideo"][data-edit-modal-id]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            lastEditModalId = btn.getAttribute('data-edit-modal-id');
            let lessonSelectId = btn.getAttribute('data-lesson-select-id');
            // Set both on the modal and the form
            document.getElementById('addLessonModalAddVideo').setAttribute('data-edit-modal-id', lastEditModalId);
            document.querySelector('#addLessonModalAddVideo .ajax-add-lesson-form').setAttribute('data-target-lesson-select-id', lessonSelectId);
        });
    });

    // When Add Lesson is opened from Add Video modal, reset to default
    document.querySelectorAll('[data-target="#addLessonModalAddVideo"]:not([data-edit-modal-id])').forEach(function(btn) {
        btn.addEventListener('click', function() {
            lastEditModalId = null;
            document.getElementById('addLessonModalAddVideo').removeAttribute('data-edit-modal-id');
            document.querySelector('#addLessonModalAddVideo .ajax-add-lesson-form').setAttribute('data-target-lesson-select-id', 'add_lesson');
        });
    });

    // AJAX submit for add lesson (used in both add and edit flows)
    document.querySelectorAll('.ajax-add-lesson-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            let formData = new FormData(form);
            let url = form.getAttribute('action');

            fetch(url, {
                method: "POST",
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            })
            .then(response => {
                return response.json().catch(() => null);
            })
            .then(data => {
                if (!data) {
                    showAlert('danger', 'Unexpected server response.', form);
                    return;
                }
                if (data.success) {
                    showAlert('success', data.message, form);

                    // Update the related lesson select
                    let lessonSelectId = form.getAttribute('data-target-lesson-select-id');
                    let lessonSelect = document.getElementById(lessonSelectId);
                    if (lessonSelect) {
                        if (!lessonSelect.querySelector(`option[value="${data.lesson.id}"]`)) {
                            let option = document.createElement('option');
                            option.value = data.lesson.id;
                            option.text = data.lesson.name;
                            option.setAttribute('data-course-id', data.lesson.course_id || '');
                            lessonSelect.appendChild(option);
                        }
                        lessonSelect.value = data.lesson.id;
                    }

                    // Hide modal & reset form
                    let modal = form.closest('.modal');
                    setTimeout(() => {
                        if (modal) $(modal).modal('hide');
                        form.reset();
                    }, 500);

                } else {
                    showAlert('danger', data.message, form);
                }
            })
            .catch(err => {
                showAlert('danger', 'An error occurred while adding the lesson.', form);
                console.error(err);
            });
        });
    });

    // Accept form as third argument to showAlert
    function showAlert(type, message, form) {
        let alertDiv = null;
        // If Add Lesson opened from Add Video modal, show in Add Video modal
        if (form && form.closest('#addLessonModalAddVideo') && !document.getElementById('addLessonModalAddVideo').getAttribute('data-edit-modal-id')) {
            alertDiv = document.getElementById('addVideoModalAlert');
            if (alertDiv) alertDiv.innerHTML = '';
        }
        // If opened from Edit Video modal, show in that modal's alert container
        else if (form && form.closest('#addLessonModalAddVideo') && document.getElementById('addLessonModalAddVideo').getAttribute('data-edit-modal-id')) {
            let editId = document.getElementById('addLessonModalAddVideo').getAttribute('data-edit-modal-id');
            alertDiv = document.getElementById('editVideoModalAlert' + editId);
            if (alertDiv) alertDiv.innerHTML = '';
        }
        // Create alert element
        const alertElem = document.createElement('div');
        alertElem.className = `alert alert-${type} alert-dismissible fade show custom-ajax-alert`;
        alertElem.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>`;
        // Insert alert in the right place
        if (alertDiv) {
            alertDiv.appendChild(alertElem);
        } else {
            // fallback: show at top of card-box
            document.querySelectorAll('.custom-ajax-alert').forEach(el => el.remove());
            const contentArea = document.querySelector('.card-box') || document.body;
            contentArea.insertBefore(alertElem, contentArea.firstChild);
        }
        setTimeout(() => { if (alertElem.parentNode) $(alertElem).alert('close'); }, 4000);
    }

    // Helper function to filter lessons by course
    function filterLessonsByCourse(lessonSelect, courseId) {
        if (!lessonSelect) return;
        Array.from(lessonSelect.options).forEach(function(opt) {
            if (!opt.value) {
                opt.style.display = '';
                return;
            }
            if (opt.getAttribute('data-course-id') === courseId) {
                opt.style.display = '';
            } else {
                opt.style.display = 'none';
            }
        });
        // If selected option is not visible, reset selection
        if (lessonSelect.selectedOptions.length && lessonSelect.selectedOptions[0].style.display === 'none') {
            lessonSelect.value = '';
        }
    }

    // Add Video Modal: filter lessons when course changes
    var addCourseSelect = document.getElementById('add_course');
    var addLessonSelect = document.getElementById('add_lesson');
    if (addCourseSelect && addLessonSelect) {
        addCourseSelect.addEventListener('change', function() {
            filterLessonsByCourse(addLessonSelect, addCourseSelect.value);
        });
        // Initial filter
        filterLessonsByCourse(addLessonSelect, addCourseSelect.value);
    }

    // Edit Video Modals: filter lessons when course changes
    {% for video in videos %}
    (function() {
        var courseSel = document.getElementById('course{{video.id}}');
        var lessonSel = document.getElementById('lesson{{video.id}}');
        if (courseSel && lessonSel) {
            courseSel.addEventListener('change', function() {
                filterLessonsByCourse(lessonSel, courseSel.value);
            });
            // Initial filter
            filterLessonsByCourse(lessonSel, courseSel.value);
        }

        // Thumbnail preview on edit modal when user selects a new image
        var thumbInput = document.getElementById('thumbnail{{video.id}}');
        var thumbPreview = document.getElementById('thumbnailPreview{{video.id}}');
        if (thumbInput && thumbPreview) {
            thumbInput.addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(ev) {
                    thumbPreview.src = ev.target.result;
                    thumbPreview.style.display = 'inline-block';
                }
                reader.readAsDataURL(file);
            });
        }
    })();
    {% endfor %}

    // Add Video thumbnail preview
    var addThumbInput = document.getElementById('add_thumbnail');
    var addThumbPreview = document.getElementById('addThumbnailPreview');
    if (addThumbInput && addThumbPreview) {
        addThumbInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) {
                addThumbPreview.style.display = 'none';
                addThumbPreview.src = '';
                return;
            }
            var reader = new FileReader();
            reader.onload = function(ev) {
                addThumbPreview.src = ev.target.result;
                addThumbPreview.style.display = 'inline-block';
            }
            reader.readAsDataURL(file);
        });
    }

});
</script>

<!-- Keep toast notifications included again if needed by layout -->
<body>
  {% include 'dashboard/toast_notification.html' %}
</body>

{% endblock %}
