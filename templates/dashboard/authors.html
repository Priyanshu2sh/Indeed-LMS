{% extends 'dashboard/base.html' %}
{% load static %}
{% block content %}
{% include 'dashboard/toast_notification.html' %}

<style>
  /* Responsive Table */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .authors-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap;
    width: 100%;
  }

  @media (max-width: 992px) {
    .authors-header-row {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;
    }
    .authors-header-row h4 {
      font-size: 18px;
      margin-bottom: 0;
    }
    .authors-header-row .btn {
      margin-top: 0;
      width: auto;
      min-width: 100px;
      font-size: 15px;
      text-align: right;
    }
    .modal-dialog {
      max-width: 95% !important;
      margin: 1rem auto;
    }
  }

  @media (max-width: 768px) {
    .card-box .pd-20 {
      padding-bottom: 10px;
    }
    table.data-table {
      width: 100%;
      min-width: 800px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
    }
    .form-row .form-group {
      width: 100% !important;
      padding-right: 0;
      padding-left: 0;
    }
    .modal-footer .btn {
      width: 100%;
      margin-top: 8px;
    }
    .form-group label {
      font-size: 14px;
    }
    .form-control {
      font-size: 14px;
      padding: 8px;
    }
    table.data-table th,
    table.data-table td {
      font-size: 13px;
      white-space: nowrap;
    }
    img {
      max-width: 50px;
      height: auto;
    }
  }

  @media (max-width: 480px) {
    .card-box h4 {
      font-size: 18px;
    }
    .modal-title {
      font-size: 16px;
    }
    button, .btn {
      font-size: 14px;
      padding: 8px 12px;
    }
    .form-group {
      margin-bottom: 0.8rem;
    }
  }
</style>

<div class="card-box mb-30">
  <div class="pd-20 authors-header-row">
    <h4 class="text-blue h4 mb-2">Authors</h4>
    <!-- Add Author Button -->
    <button
      type="button"
      class="btn btn-primary"
      data-toggle="modal"
      data-target="#addAuthorModal"
    >
      <i class="fa fa-plus"></i> Add Author
    </button>
  </div>

  <div class="pb-20 table-responsive">
    <table class="data-table table stripe hover nowrap">
      <thead>
        <tr>
          <th class="table-plus datatable-nosort">Name</th>
          <th>About</th>
          <th>Profile</th>
          <th class="datatable-nosort">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for author in authors %}
        <tr>
          <td class="table-plus">{{author.name}}</td>
          <td>{{author.about_author}}</td>
          <td>
            <img
              src="{{author.author_profile.url}}"
              alt="profile"
              width="60"
              height="60"
              class="rounded-circle"
            />
          </td>
          <td>
            <div class="dropdown">
              <a
                class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle"
                href="#"
                role="button"
                data-toggle="dropdown"
              >
                <i class="dw dw-more"></i>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
              >
                <a
                  class="dropdown-item view-author"
                  href="#"
                  data-id="{{author.id}}"
                  data-name="{{author.name}}"
                  data-about="{{author.about_author|escapejs}}"
                  data-profile="{{author.author_profile.url}}"
                  ><i class="dw dw-eye"></i> View</a
                >
                <a
                  class="dropdown-item edit-author"
                  href="#"
                  data-id="{{author.id}}"
                  data-name="{{author.name}}"
                  data-about="{{author.about_author|escapejs}}"
                  data-profile="{{author.author_profile.url}}"
                  ><i class="dw dw-edit2"></i> Edit</a
                >
                <a
                  class="dropdown-item delete-author"
                  href="#"
                  data-id="{{author.id}}"
                  ><i class="dw dw-delete-3"></i> Delete</a
                >
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Author View Modal -->
<div class="modal fade" id="authorViewModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Author Details</h5>
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <img
            id="authorProfileImg"
            src=""
            alt="Profile"
            style="max-width: 100px; max-height: 100px; border-radius: 50%"
          />
        </div>
        <table class="table table-bordered">
          <tbody>
            <tr>
              <th>Name</th>
              <td id="authorName"></td>
            </tr>
            <tr>
              <th>About</th>
              <td id="authorAbout"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Author Edit Modal -->
<div class="modal fade" id="authorEditModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form
        id="editAuthorForm"
        method="post"
        enctype="multipart/form-data"
        action="{% url 'edit_author' %}"
      >
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Edit Author</h5>
          <button type="button" class="close" data-dismiss="modal">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editAuthorId" />
          <div class="form-group">
            <label>Name</label>
            <input
              type="text"
              class="form-control"
              name="name"
              id="editAuthorName"
              required
            />
          </div>
          <div class="form-group">
            <label>About</label>
            <textarea
              class="form-control"
              name="about_author"
              id="editAuthorAbout"
              rows="3"
            ></textarea>
          </div>
          <div class="form-group">
            <label>Profile Image</label>
            <input
              type="file"
              class="form-control"
              name="author_profile"
              id="editAuthorProfile"
              accept="image/*"
            />
            <div class="mt-2 text-center">
              <img
                id="editAuthorProfilePreview"
                src=""
                alt="Profile Preview"
                style="max-width: 80px; max-height: 80px; display: none; border-radius: 50%"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Author Delete Modal -->
<div class="modal fade" id="authorDeleteModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form
        id="deleteAuthorForm"
        method="post"
        action="{% url 'delete_author' %}"
      >
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Delete Author</h5>
          <button type="button" class="close" data-dismiss="modal">
            &times;
          </button>
        </div>
        <div class="modal-body text-center">
          <input type="hidden" name="id" id="deleteAuthorId" />
          <p>Are you sure you want to delete this author?</p>
        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button
            type="button"
            class="btn btn-secondary mx-2"
            data-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-danger mx-2">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Author Modal -->
<div
  class="modal fade"
  id="addAuthorModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="addAuthorModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <form
      method="post"
      action="{% url 'add_author' %}"
      enctype="multipart/form-data"
    >
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAuthorModalLabel">
            <i class="fa fa-plus"></i> Add Author
          </h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="add_author_name">Name</label>
              <input
                type="text"
                class="form-control"
                id="add_author_name"
                name="name"
                required
              />
            </div>
            <div class="form-group col-md-6">
              <label for="add_author_profile">Profile Image</label>
              <input
                type="file"
                class="form-control"
                id="add_author_profile"
                name="author_profile"
                accept="image/*"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="add_about_author">About Author</label>
            <textarea
              class="form-control"
              id="add_about_author"
              name="about_author"
              rows="3"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-plus"></i> Add Author
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // View
    document.querySelectorAll(".view-author").forEach(function (button) {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("authorName").innerText =
          this.dataset.name || "";
        document.getElementById("authorAbout").innerText =
          this.dataset.about || "";
        document.getElementById("authorProfileImg").src =
          this.dataset.profile || "";
        $("#authorViewModal").modal("show");
      });
    });

    // Edit
    document.querySelectorAll(".edit-author").forEach(function (button) {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("editAuthorId").value = this.dataset.id;
        document.getElementById("editAuthorName").value =
          this.dataset.name || "";
        document.getElementById("editAuthorAbout").value =
          this.dataset.about || "";
        var profileUrl = this.dataset.profile || "";
        var preview = document.getElementById("editAuthorProfilePreview");
        if (profileUrl) {
          preview.src = profileUrl;
          preview.style.display = "block";
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
        $("#authorEditModal").modal("show");
      });
    });

    // Profile image preview in edit modal
    document
      .getElementById("editAuthorProfile")
      .addEventListener("change", function (e) {
        const file = e.target.files[0];
        const preview = document.getElementById("editAuthorProfilePreview");
        if (file) {
          const reader = new FileReader();
          reader.onload = function (ev) {
            preview.src = ev.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

    // Delete
    document.querySelectorAll(".delete-author").forEach(function (button) {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("deleteAuthorId").value = this.dataset.id;
        $("#authorDeleteModal").modal("show");
      });
    });
  });
</script>

{% endblock %}
