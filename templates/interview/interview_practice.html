{% extends "base.html" %}
{% block content %}
<style>
  .shape-left {
    left: 0;
    max-width: 0;
    overflow: hidden;
  }

  .interview-page {
    background: #f8f9fc;
    min-height: 100vh;
    display: flex;
    align-items: start;
    justify-content: center;
    padding: 3rem 0;
  }

  .interview-page .left-section {
    background: white;
    border-radius: 18px;
    padding: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    text-align: left;
    height: 100%;
  }

  .interview-page .left-section h2 {
    font-weight: 700;
    color: #1a237e;
    margin-bottom: 1.5rem;
    font-size: 1.7rem;
  }

  .interview-page .left-section p {
    color: #555;
    line-height: 1.6;
    font-size: 1.3rem;
  }

  .interview-page .right-section {
    background: white;
    border-radius: 18px;
    padding: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .interview-page .form-title {
    font-weight: 600;
    color: #0d47a1;
    border-bottom: 2px solid #0d47a1;
    padding-bottom: 6px;
    margin-bottom: 1.5rem;
  }

  .interview-page .custom-label {
    color: #333;
    font-weight: 600;
  }

  .interview-page .custom-input {
    border-radius: 10px;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    transition: all 0.2s ease-in-out;
  }

  .interview-page .custom-input:focus {
    border-color: #0d47a1;
    box-shadow: 0 0 6px rgba(13, 71, 161, 0.3);
  }

  .interview-page .start-btn {
    background: linear-gradient(90deg, #1e88e5, #3949ab);
    border: none;
    border-radius: 12px;
    padding: 0.75rem;
    font-size: 1.1rem;
    font-weight: 600;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    color: #fff;
  }

  .interview-page .start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(30, 136, 229, 0.4);
  }

  @media (max-width: 768px) {
    .interview-page .left-section,
    .interview-page .right-section {
      margin-bottom: 1.5rem;
    }
  }

  .interview-setup-page .fadeIn {
    animation: fadeInUpInterview 0.8s ease both;
  }
</style>

<div class="interview-page">
  <div class="container">
    <div class="row g-10 align-items-stretch">
      <!-- Left Section -->
      <div class="col-md-5">
        <div class="left-section h-100">
          <h2>ğŸ¯ Interview Practice Module</h2>
          <p>
            Sharpen your interview skills with our AI-powered practice module. Experience realistic, simulated sessions tailored to your goals and comfort level. Whether preparing for technical or HR rounds, our intelligent system helps you train effectively with dynamic, context-aware questions.
          </p>
          <p>Upload your resume and job description to personalize your session with role-relevant questions.</p>

          {% if already_paid %}
            <div class="alert alert-success mt-4">
              âœ… You already have access!  
              <br>
              <b>Remaining Time:</b> {{ time_remaining }}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Right Section -->
      <div class="col-md-7">
        <div class="right-section h-100">
          <h5 class="form-title">ğŸ§© Set Up Your Interview</h5>

          <form id="interviewForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Interview Type -->
            <div class="mb-3">
              <label for="interviewType" class="custom-label">Choose Interview Type</label>
              <select class="form-select custom-input" id="interviewType" name="interviewType" required>
                <option value="">-- Select Type --</option>
                <option value="hr">HR Interview</option>
                <option value="technical">Technical Interview</option>
              </select>
            </div>

            <!-- Difficulty -->
            <div class="mb-3">
              <label for="difficulty" class="custom-label">Select Difficulty</label>
              <select class="form-select custom-input" id="difficulty" name="difficulty" required>
                <option value="">-- Select Difficulty --</option>
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>

            <!-- JD Upload -->
            <div class="mb-3">
              <label for="jdFile" class="custom-label">Upload Job Description</label>
              <input class="form-control custom-input" type="file" id="jdFile" name="jdFile" accept=".pdf,.doc,.docx" required>
            </div>

            <!-- Resume Upload -->
            <div class="mb-4">
              <label for="resumeFile" class="custom-label">Upload Resume</label>
              <input class="form-control custom-input" type="file" id="resumeFile" name="resumeFile" accept=".pdf,.doc,.docx" required>
            </div>

            <!-- Start Button -->
            <div class="d-grid mt-4 text-center">
              {% load static %}
              {% if already_paid %}
                <!-- Case 1: User already paid -->
                <button id="startDemoBtn"
                        type="button"
                        class="start-btn"
                        style="background: linear-gradient(90deg, #10b981, #059669); border:none; color:white; padding:12px 20px; border-radius:8px; font-size:16px;">
                  ğŸš€ Continue Interview Session
                </button>
                <p id="demoPriceInfo" style="margin-top:8px; color:#555;">
                  You have an active session. Resume anytime before it expires.
                </p>

              {% elif demo_used and paid_demo %}
                <!-- Case 2: Demo is paid -->
                <button id="startDemoBtn"
                        type="button"
                        class="start-btn"
                        style="background: linear-gradient(90deg, #f59e0b, #d97706); border:none; color:white; padding:12px 20px; border-radius:8px; font-size:16px;">
                  ğŸš€ Start 5-min Demo
                </button>
                <p id="demoPriceInfo" style="margin-top:8px; color:#555;">
                  ğŸ’° This demo costs â‚¹{{demo_price}}. Youâ€™ll be redirected to secure payment.
                </p>

              {% elif demo_used and not paid_demo %}
                <!-- Case 2: Demo is paid -->
                <button id="startDemoBtn"
                        type="button"
                        class=""
                        style="background: linear-gradient(90deg, #cbc0ae, #5b5753); border:none; color:white; padding:12px 20px; border-radius:8px; font-size:16px;" disabled>
                  ğŸš€ Start 5-min Demo
                </button>
                <p id="demoPriceInfo" style="margin-top:8px; color:#555;">
                  You have already used your demo completely. Please contact admin for further access.
                </p>

              {% elif paid_demo %}
                <!-- Case 2: Demo is paid -->
                <button id="startDemoBtn"
                        type="button"
                        class="start-btn"
                        style="background: linear-gradient(90deg, #f59e0b, #d97706); border:none; color:white; padding:12px 20px; border-radius:8px; font-size:16px;">
                  ğŸš€ Start 5-min Demo
                </button>
                <p id="demoPriceInfo" style="margin-top:8px; color:#555;">
                  ğŸ’° This demo costs â‚¹{{demo_price}}. Youâ€™ll be redirected to secure payment.
                </p>

              {% else %}
                <!-- Case 3: Demo is free -->
                <button id="startDemoBtn"
                        type="button"
                        class="start-btn"
                        style="background: linear-gradient(90deg, #3b82f6, #2563eb); border:none; color:white; padding:12px 20px; border-radius:8px; font-size:16px;">
                  ğŸš€ Start Free Demo
                </button>
                <p id="demoPriceInfo" style="margin-top:8px; color:#555;">
                  ğŸ‰ Enjoy your free practice session!
                </p>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  console.log("ğŸŸ¢ Page loaded, initializing demo setup...");
  
  const startBtn = document.getElementById('startDemoBtn');
  const form = document.getElementById('interviewForm');

  try {

    // âœ… 2. Attach button click handler
    startBtn.onclick = async () => {
      console.log("ğŸŸ© Start Demo button clicked.");

      try {
        // 2.1 Validate form inputs
        const interviewType = form.querySelector('select[name="interviewType"]').value;
        const difficulty = form.querySelector('select[name="difficulty"]').value;
        const jdFile = form.querySelector('input[name="jdFile"]').files[0];
        const resumeFile = form.querySelector('input[name="resumeFile"]').files[0];

        console.log("ğŸ“‹ Current input values:", { interviewType, difficulty, jdFile, resumeFile });

        if (!interviewType || !difficulty || !jdFile || !resumeFile) {
          alert("Please fill all fields and upload both files before starting the demo.");
          console.error("âŒ Missing input fields or files.");
          return;
        }

        // âœ… 3. Save form inputs
        console.log("ğŸ’¾ Saving form data...");
        const formData = new FormData(form);
        const saveResp = await fetch("{% url 'save_demo_inputs' %}", {
          method: "POST",
          body: formData,
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
        });

        console.log("ğŸ’¾ Save response status:", saveResp.status);
        const saveData = await saveResp.json();
        console.log("ğŸ’¾ Save response JSON:", saveData);

        if (!saveData.success) {
          alert("Error saving your details. Please try again.");
          console.error("âŒ Save failed:", saveData);
          return;
        }

        if (saveData.redirect == true) {
          window.location.href = "{% url 'interview_page' %}";
          return;
        }

        // âœ… 4. If free demo, skip payment
        // if (!saveData.demo_is_paid) {
        //   console.log("ğŸ†“ Free demo detected â†’ redirecting directly...");
        //   window.location.href = "{% url 'start_demo' %}";
        //   return;
        // }

        // âœ… 5. Create Razorpay order
        console.log("ğŸ’° Creating Razorpay order...");
        const orderResp = await fetch("{% url 'create_demo_order' %}", {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
        });

        console.log("ğŸ’° Order response status:", orderResp.status);
        const orderData = await orderResp.json();
        console.log("ğŸ“¦ Order data:", orderData);

        if (!orderResp.ok || !orderData.razorpay_order_id) {
          console.error("âŒ Failed to create order:", orderData);
          alert("Unable to create payment order. Please check console logs.");
          return;
        }

        // âœ… 6. Initialize Razorpay
        console.log("ğŸ§© Initializing Razorpay checkout...");

        const options = {
          key: orderData.razorpay_key_id,
          amount: orderData.amount,
          currency: "INR",
          name: "Indeed Inspiring Infotech",
          description: "5-min Demo Session",
          order_id: orderData.razorpay_order_id,
          callback_url: orderData.razorpay_callback_url,
          prefill: { email: orderData.user_email },
          theme: { color: "#1a73e8" },
        };

        const rzp = new Razorpay(options);
        rzp.on("payment.failed", function (response) {
          console.error("âŒ Payment failed event triggered:", response.error);
          alert("Payment failed. Check console for error details.");
        });

        console.log("ğŸš€ Opening Razorpay popup now...");
        rzp.open();

      } catch (err) {
        console.error("ğŸ”¥ Error inside start demo flow:", err);
        alert("An unexpected error occurred. Check console logs.");
      }
    };

  } catch (e) {
    console.error("âŒ Failed to load demo config:", e);
    alert("Error initializing demo. Check console logs.");
  }
});
</script>
{% endblock content %}
