{% extends 'dashboard/base.html' %} 
{% load static %} 
{% block content %}
{% include 'dashboard/toast_notification.html' %}

<style>
  /* Responsive Table */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Header row for Courses and Add Course button */
  .courses-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap;
    width: 100%;
  }

  @media (max-width: 992px) {
    .courses-header-row {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;
    }
    .courses-header-row h4 {
      font-size: 18px;
      margin-bottom: 0;
    }
    .courses-header-row .btn {
      margin-top: 0;
      width: auto;
      min-width: 100px;
      font-size: 15px;
      text-align: right;
    }
    .modal-dialog {
      max-width: 95% !important;
      margin: 1rem auto;
    }
  }

  @media (max-width: 768px) {
    .card-box .pd-20 {
      padding-bottom: 10px;
    }
    table.data-table {
      width: 100%;
      min-width: 800px; /* allow horizontal scroll for many columns */
    }
    .form-row {
      display: flex;
      flex-direction: column;
    }
    .form-row .form-group {
      width: 100% !important;
      padding-right: 0;
      padding-left: 0;
    }
    .modal-footer .btn {
      width: 100%;
      margin-top: 8px;
    }
    .form-group label {
      font-size: 14px;
    }
    .form-control {
      font-size: 14px;
      padding: 8px;
    }
    table.data-table th,
    table.data-table td {
      font-size: 13px;
      white-space: nowrap;
    }
  }

  @media (max-width: 480px) {
    .card-box h4 {
      font-size: 18px;
    }
    .modal-title {
      font-size: 16px;
    }
    button, .btn {
      font-size: 14px;
      padding: 8px 12px;
    }
    .form-group {
      margin-bottom: 0.8rem;
    }
  }
</style>

<div class="card-box mb-30">
  <div class="pd-20 courses-header-row">
    <h4 class="text-blue h4">Courses</h4>
    <!-- Add Course Button -->
    <button
      type="button"
      class="btn btn-primary"
      data-toggle="modal"
      data-target="#addCourseModal"
    >
      <i class="fa fa-plus"></i> Add Course
    </button>
  </div>
  <div class="pb-20 table-responsive">
    <table class="data-table table stripe hover nowrap">
      <thead>
        <tr>
          <th class="table-plus datatable-nosort">Name</th>
          <th>Category</th>
          <th>Level</th>
          <th>Price(â‚¹)</th>
          <th>Discount(%)</th>
          <th>Language</th>

          <th class="datatable-nosort">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for course in courses %}
        <tr>
          <td class="table-plus">{{course.title|truncatechars:15}}</td>
          <td>{{course.category}}</td>
          <td>{{course.level}}</td>
          <td>{{course.price}}</td>
          <td>{{course.discount}}</td>
          <td>{{course.language}}</td>

          <td>
            <div class="dropdown">
              <a
                class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle"
                href="#"
                role="button"
                data-toggle="dropdown"
              >
                <i class="dw dw-more"></i>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
              >
                <!-- VIEW -->
                <a
                  class="dropdown-item view-course"
                  href="#"
                  data-title="{{course.title}}"
                  data-category="{{course.category}}"
                  data-level="{{course.level}}"
                  data-price="{{course.price}}"
                  data-discount="{{course.discount}}"
                  data-language="{{course.language}}"
                  data-certificate="{{course.certificate}}"
                  data-assessment="{{course.assessment_type}}"
                  data-subscription="{% if course.is_subscription %}Yes{% else %}No{% endif %}"
                >
                  <i class="dw dw-eye"></i> View
                </a>

                <!-- EDIT -->
                <a
                  class="dropdown-item edit-course"
                  href="#"
                  data-id="{{course.id}}"
                  data-title="{{course.title}}"
                  data-category="{{course.category.id}}"
                  data-level="{{course.level.id}}"
                  data-price="{{course.price}}"
                  data-discount="{{course.discount}}"
                  data-language="{% if course.language %}{{course.language.id}}{% endif %}"
                  data-certificate="{{course.certificate}}"
                  data-assessment="{{course.assessment_type}}"
                  data-subscription="{{course.is_subscription}}"
                  data-status="{{course.status}}"
                  data-deadline="{{course.Deadline}}"
                  data-description="{{course.description}}"
                  data-author="{{course.author.id}}"
                  data-featuredvideo="{{course.featured_video}}"
                  data-featuredimage="{% if course.featured_image %}{{ course.featured_image.url }}{% endif %}"
                  data-template="{% if course.template %}{{ course.template.url }}{% endif %}"
                  data-whatyoulearn='[{% for item in course.what_you_learn_set.all %}"{{ item.points|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                  data-requirements='[{% for item in course.requirements_set.all %}"{{ item.points|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                >
                  <i class="dw dw-edit2"></i> Edit
                </a>

                <a
                  class="dropdown-item delete-course"
                  href="#"
                  data-id="{{course.id}}"
                >
                  <i class="dw dw-delete-3"></i> Delete
                </a>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ============================= -->
<!-- VIEW MODAL -->
<!-- ============================= -->
<div class="modal fade" id="courseViewModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Course Details</h5>
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <tbody>
            <tr>
              <th>Name</th>
              <td id="courseTitle"></td>
            </tr>
            <tr>
              <th>Category</th>
              <td id="courseCategory"></td>
            </tr>
            <tr>
              <th>Level</th>
              <td id="courseLevel"></td>
            </tr>
            <tr>
              <th>Price</th>
              <td id="coursePrice"></td>
            </tr>
            <tr>
              <th>Discount</th>
              <td id="courseDiscount"></td>
            </tr>
            <tr>
              <th>Language</th>
              <td id="courseLanguage"></td>
            </tr>
            <tr>
              <th>Certificate</th>
              <td id="courseCertificate"></td>
            </tr>
            <tr>
              <th>Assessment Type</th>
              <td id="courseAssessment"></td>
            </tr>
            <tr>
              <th>Monthly Subscription</th>
              <td id="courseSubscription"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- EDIT MODAL -->
<!-- ============================= -->
<div class="modal fade" id="courseEditModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form
        id="editCourseForm"
        method="post"
        enctype="multipart/form-data"
        action="{% url 'edit_course' %}"
      >
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Edit Course</h5>
          <button type="button" class="close" data-dismiss="modal">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editCourseId" />

          <div class="form-group">
            <label>Title</label>
            <input
              type="text"
              class="form-control"
              name="title"
              id="editCourseTitle"
              required
            />
          </div>

          <div class="form-group">
            <label>Category</label>
            <select
              class="form-control"
              name="category"
              id="editCourseCategory"
              required
            >
              <option value="">Select Category</option>
              {% for cat in categories %}
              <option value="{{cat.id}}">{{cat.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Level</label>
            <select
              class="form-control"
              name="level"
              id="editCourseLevel"
              required
            >
              <option value="">Select Level</option>
              {% for lvl in levels %}
              <option value="{{lvl.id}}">{{lvl.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Author</label>
            <select
              class="form-control"
              name="author"
              id="editCourseAuthor"
              required
            >
              <option value="">Select Author</option>
              {% for auth in authors %}
              <option value="{{auth.id}}">{{auth.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Language</label>
            <select
              class="form-control"
              name="language"
              id="editCourseLanguage"
            >
              <option value="">Select Language</option>
              {% for lang in languages %}
              <option value="{{lang.id}}">{{lang.language}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea
              class="form-control"
              name="description"
              id="editCourseDescription"
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Price</label>
            <input
              type="number"
              class="form-control"
              name="price"
              id="editCoursePrice"
              min="0"
              required
            />
          </div>

          <div class="form-group">
            <label>Discount</label>
            <input
              type="number"
              class="form-control"
              name="discount"
              id="editCourseDiscount"
              min="0"
              max="100"
            />
          </div>

          <div class="form-group">
            <label>Deadline</label>
            <input
              type="text"
              class="form-control"
              name="Deadline"
              id="editCourseDeadline"
              placeholder="e.g., 30 days"
            />
          </div>

          <div class="form-group">
            <label>Status</label>
            <select
              class="form-control"
              name="status"
              id="editCourseStatus"
              required
            >
              <option value="PUBLISH">PUBLISH</option>
              <option value="DRAFT">DRAFT</option>
            </select>
          </div>

          <div class="form-group">
            <label>Certificate</label>
            <select
              class="form-control"
              name="certificate"
              id="editCourseCertificate"
              required
            >
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Assessment Type</label>
            <select
              class="form-control"
              name="assessment_type"
              id="editCourseAssessment"
              required
            >
              <option value="Day">Day</option>
              <option value="Final">Final</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Monthly Subscription</label>
            <select
              class="form-control"
              name="is_subscription"
              id="editCourseSubscription"
              required
            >
              <option value="True">Yes</option>
              <option value="False">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Featured Video URL</label>
            <input
              type="text"
              class="form-control"
              name="featured_video"
              id="editCourseVideo"
              placeholder="https://example.com/video.mp4"
            />
          </div>

          <div class="form-group">
            <label>Featured Image</label>
            <input
              type="file"
              class="form-control"
              name="featured_image"
              id="editCourseFeaturedImage"
              accept="image/*"
            />
            <small class="form-text text-muted">Current image:</small>
            <div class="mt-2">
              <img
                id="featuredImagePreview"
                src=""
                alt="Featured Image Preview"
                style="max-width: 100px; max-height: 100px; display: none"
              />
            </div>
          </div>

          <div class="form-group">
            <label>Certificate Template</label>
            <input
              type="file"
              class="form-control"
              name="template"
              id="editCourseTemplate"
              accept="image/*"
            />
            <small class="form-text text-muted">Current template:</small>
            <div class="mt-2">
              <img
                id="templatePreview"
                src=""
                alt="Certificate Template Preview"
                style="max-width: 100px; max-height: 100px; display: none"
              />
            </div>
          </div>

          <!-- What You Learn Section -->
          <div class="form-group">
            <label>What you learn</label>
            <div id="whatYouLearnList">
              <!-- Existing items will be inserted here by JS -->
            </div>
            <div class="input-group mb-2">
              <input
                type="text"
                class="form-control"
                id="whatYouLearnInput"
                placeholder="Add what you learn..."
              />
              <div class="input-group-append">
                <button
                  type="button"
                  class="btn btn-success"
                  id="addWhatYouLearnBtn"
                >
                  <i class="fa fa-plus"></i> Add
                </button>
              </div>
            </div>
            <input
              type="hidden"
              name="what_you_learn"
              id="whatYouLearnHidden"
            />
          </div>

          <!-- Requirements Section -->
          <div class="form-group">
            <label>Requirements</label>
            <div id="requirementsList">
              <!-- Existing items will be inserted here by JS -->
            </div>
            <div class="input-group mb-2">
              <input
                type="text"
                class="form-control"
                id="requirementsInput"
                placeholder="Add requirement..."
              />
              <div class="input-group-append">
                <button
                  type="button"
                  class="btn btn-success"
                  id="addRequirementsBtn"
                >
                  <i class="fa fa-plus"></i> Add
                </button>
              </div>
            </div>
            <input type="hidden" name="requirements" id="requirementsHidden" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCourseModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Course</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete this course? This action cannot be
          undone.
        </p>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button
          type="button"
          class="btn btn-secondary mx-2"
          data-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-danger mx-2"
          id="confirmDeleteCourseBtn"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- ADD COURSE MODAL -->
<!-- ============================= -->
<div class="modal fade" id="addCourseModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form
        id="addCourseForm"
        method="post"
        enctype="multipart/form-data"
        action="{% url 'add_course' %}"
      >
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Course</h5>
          <button type="button" class="close" data-dismiss="modal">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Title</label>
            <input type="text" class="form-control" name="title" required />
          </div>

          <div class="form-group">
            <label>Category</label>
            <select
              class="form-control"
              name="category"
              required
            >
              <option value="">Select Category</option>
              {% for cat in categories %}
              <option value="{{cat.id}}">{{cat.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Level</label>
            <select
              class="form-control"
              name="level"
              required
            >
              <option value="">Select Level</option>
              {% for lvl in levels %}
              <option value="{{lvl.id}}">{{lvl.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Author</label>
            <select
              class="form-control"
              name="author"
              required
            >
              <option value="">Select Author</option>
              {% for auth in authors %}
              <option value="{{auth.id}}">{{auth.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Language</label>
            <select
              class="form-control"
              name="language"
            >
              <option value="">Select Language</option>
              {% for lang in languages %}
              <option value="{{lang.id}}">{{lang.language}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea
              class="form-control"
              name="description"
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Price</label>
            <input
              type="number"
              class="form-control"
              name="price"
              min="0"
              required
            />
          </div>

          <div class="form-group">
            <label>Discount</label>
            <input
              type="number"
              class="form-control"
              name="discount"
              min="0"
              max="100"
            />
          </div>

          <div class="form-group">
            <label>Deadline</label>
            <input
              type="text"
              class="form-control"
              name="Deadline"
              placeholder="e.g., 30 days"
            />
          </div>

          <div class="form-group">
            <label>Status</label>
            <select
              class="form-control"
              name="status"
              required
            >
              <option value="PUBLISH">PUBLISH</option>
              <option value="DRAFT">DRAFT</option>
            </select>
          </div>

          <div class="form-group">
            <label>Certificate</label>
            <select
              class="form-control"
              name="certificate"
              required
            >
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Assessment Type</label>
            <select
              class="form-control"
              name="assessment_type"
              required
            >
              <option value="Day">Day</option>
              <option value="Final">Final</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Monthly Subscription</label>
            <select
              class="form-control"
              name="is_subscription"
              required
            >
              <option value="True">Yes</option>
              <option value="False">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Featured Video URL</label>
            <input
              type="text"
              class="form-control"
              name="featured_video"
              placeholder="https://example.com/video.mp4"
            />
          </div>

          <div class="form-group">
            <label>Featured Image</label>
            <input
              type="file"
              class="form-control"
              name="featured_image"
              accept="image/*"
            />
          </div>

          <div class="form-group">
            <label>Certificate Template</label>
            <input
              type="file"
              class="form-control"
              name="template"
              accept="image/*"
            />
          </div>

          <!-- What You Learn Section (same as edit modal) -->
          <div class="form-group">
            <label>What you learn</label>
            <div id="addWhatYouLearnList"></div>
            <input
              type="hidden"
              name="what_you_learn"
              id="addWhatYouLearnHidden"
            />
          </div>

          <!-- Requirements Section (same as edit modal) -->
          <div class="form-group">
            <label>Requirements</label>
            <div id="addRequirementsList"></div>
            <input type="hidden" name="requirements" id="addRequirementsHidden" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Course</button>
        </div>
      </form>
    </div>
  </div>
</div>

<form
  id="deleteCourseForm"
  method="post"
  style="display: none"
  action="{% url 'delete_course' %}"
>
  {% csrf_token %}
  <input type="hidden" name="id" id="deleteCourseId" />
</form>

<script>
  // Move these variable declarations to the top, before any function definitions or calls
  let addWhatYouLearnItems = [];
  let addRequirementsItems = [];

  document.addEventListener("DOMContentLoaded", function () {
    // Arrays to store items and pending deletions
    let whatYouLearnItems = [];
    let requirementsItems = [];
    let whatYouLearnToDelete = [];
    let requirementsToDelete = [];

    // Function to render What You Learn items
    function renderWhatYouLearn() {
      const list = document.getElementById("whatYouLearnList");
      list.innerHTML = "";
      whatYouLearnItems.forEach((item, idx) => {
        const isDeleted = whatYouLearnToDelete.includes(idx);
        const div = document.createElement("div");
        div.className =
          "input-group mb-2" + (isDeleted ? " pending-delete" : "");
        div.style.opacity = isDeleted ? "0.5" : "1";
        div.style.textDecoration = isDeleted ? "line-through" : "none";
        div.innerHTML = `
          <input type="text" class="form-control what-you-learn-edit" data-idx="${idx}" value="${item.replace(
          /"/g,
          "&quot;"
        )}" ${isDeleted ? "readonly" : ""}>
          <div class="input-group-append">
            <button type="button" class="btn btn-danger btn-sm remove-what-you-learn" data-idx="${idx}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
      // Update hidden field (excluding items marked for deletion)
      const filtered = whatYouLearnItems.filter(
        (_, idx) => !whatYouLearnToDelete.includes(idx)
      );
      document.getElementById("whatYouLearnHidden").value =
        JSON.stringify(filtered);
    }

    // Function to render Requirements items
    function renderRequirements() {
      const list = document.getElementById("requirementsList");
      list.innerHTML = "";
      requirementsItems.forEach((item, idx) => {
        const isDeleted = requirementsToDelete.includes(idx);
        const div = document.createElement("div");
        div.className =
          "input-group mb-2" + (isDeleted ? " pending-delete" : "");
        div.style.opacity = isDeleted ? "0.5" : "1";
        div.style.textDecoration = isDeleted ? "line-through" : "none";
        div.innerHTML = `
          <input type="text" class="form-control requirement-edit" data-idx="${idx}" value="${item.replace(
          /"/g,
          "&quot;"
        )}" ${isDeleted ? "readonly" : ""}>
          <div class="input-group-append">
            <button type="button" class="btn btn-danger btn-sm remove-requirement" data-idx="${idx}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
      // Update hidden field (excluding items marked for deletion)
      const filtered = requirementsItems.filter(
        (_, idx) => !requirementsToDelete.includes(idx)
      );
      document.getElementById("requirementsHidden").value =
        JSON.stringify(filtered);
    }

    // --- FIX: Initial render for add modal dynamic fields ---
    renderAddWhatYouLearn();
    renderAddRequirements();

    // --- FIX: Remove old static add btn logic for add modal ---
    // (Remove the old listeners for addWhatYouLearnBtnAdd and addRequirementsBtnAdd)

    // --- Dynamic add for What You Learn ---
    document.getElementById("addWhatYouLearnList").addEventListener("click", function (e) {
      const addBtn = e.target.closest(".add-what-you-learn-btn-dynamic");
      if (addBtn) {
        const input = addBtn.closest(".input-group").querySelector(".add-what-you-learn-new");
        if (!input) return;
        const value = input.value.trim();
        if (value) {
          addWhatYouLearnItems.push(value);
          renderAddWhatYouLearn();
        } else {
          input.focus();
        }
      }
      const removeBtn = e.target.closest(".remove-add-what-you-learn");
      if (removeBtn) {
        const idx = parseInt(removeBtn.getAttribute("data-idx"));
        addWhatYouLearnItems.splice(idx, 1);
        renderAddWhatYouLearn();
      }
    });
    document.getElementById("addWhatYouLearnList").addEventListener("keypress", function (e) {
      if (e.target.classList.contains("add-what-you-learn-new") && e.key === "Enter") {
        e.preventDefault();
        const btn = e.target.closest(".input-group").querySelector(".add-what-you-learn-btn-dynamic");
        if (btn) btn.click();
      }
    });
    document.getElementById("addWhatYouLearnList").addEventListener("input", function (e) {
      if (e.target.classList.contains("add-what-you-learn-edit")) {
        const idx = parseInt(e.target.getAttribute("data-idx"));
        addWhatYouLearnItems[idx] = e.target.value;
        document.getElementById("addWhatYouLearnHidden").value = JSON.stringify(addWhatYouLearnItems);
      }
    });

    // --- Dynamic add for Requirements ---
    document.getElementById("addRequirementsList").addEventListener("click", function (e) {
      const addBtn = e.target.closest(".add-requirement-btn-dynamic");
      if (addBtn) {
        const input = addBtn.closest(".input-group").querySelector(".add-requirement-new");
        if (!input) return;
        const value = input.value.trim();
        if (value) {
          addRequirementsItems.push(value);
          renderAddRequirements();
        } else {
          input.focus();
        }
      }
      const removeBtn = e.target.closest(".remove-add-requirement");
      if (removeBtn) {
        const idx = parseInt(removeBtn.getAttribute("data-idx"));
        addRequirementsItems.splice(idx, 1);
        renderAddRequirements();
      }
    });
    document.getElementById("addRequirementsList").addEventListener("keypress", function (e) {
      if (e.target.classList.contains("add-requirement-new") && e.key === "Enter") {
        e.preventDefault();
        const btn = e.target.closest(".input-group").querySelector(".add-requirement-btn-dynamic");
        if (btn) btn.click();
      }
    });
    document.getElementById("addRequirementsList").addEventListener("input", function (e) {
      if (e.target.classList.contains("add-requirement-edit")) {
        const idx = parseInt(e.target.getAttribute("data-idx"));
        addRequirementsItems[idx] = e.target.value;
        document.getElementById("addRequirementsHidden").value = JSON.stringify(addRequirementsItems);
      }
    });

    // Set up event listeners for adding items
    document
      .getElementById("addWhatYouLearnBtn")
      .addEventListener("click", function () {
        const input = document.getElementById("whatYouLearnInput");
        const value = input.value.trim();
        if (value) {
          whatYouLearnItems.push(value);
          input.value = "";
          renderWhatYouLearn();
        }
      });

    document
      .getElementById("addRequirementsBtn")
      .addEventListener("click", function () {
        const input = document.getElementById("requirementsInput");
        const value = input.value.trim();
        if (value) {
          requirementsItems.push(value);
          input.value = "";
          renderRequirements();
        }
      });

    // Allow adding items with Enter key
    document
      .getElementById("whatYouLearnInput")
      .addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("addWhatYouLearnBtn").click();
        }
      });

    document
      .getElementById("requirementsInput")
      .addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("addRequirementsBtn").click();
        }
      });

    // Event delegation for removing items (mark for deletion)
    document.addEventListener("click", function (e) {
      if (
        e.target.classList.contains("remove-what-you-learn") ||
        e.target.closest(".remove-what-you-learn")
      ) {
        const button = e.target.classList.contains("remove-what-you-learn")
          ? e.target
          : e.target.closest(".remove-what-you-learn");
        const idx = parseInt(button.getAttribute("data-idx"));
        if (!whatYouLearnToDelete.includes(idx)) {
          whatYouLearnToDelete.push(idx);
          renderWhatYouLearn();
        }
      }
      if (
        e.target.classList.contains("remove-requirement") ||
        e.target.closest(".remove-requirement")
      ) {
        const button = e.target.classList.contains("remove-requirement")
          ? e.target
          : e.target.closest(".remove-requirement");
        const idx = parseInt(button.getAttribute("data-idx"));
        if (!requirementsToDelete.includes(idx)) {
          requirementsToDelete.push(idx);
          renderRequirements();
        }
      }
    });

    // VIEW functionality
    document.querySelectorAll(".view-course").forEach(function (button) {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("courseTitle").innerText =
          this.dataset.title || "N/A";
        document.getElementById("courseCategory").innerText =
          this.dataset.category || "N/A";
        document.getElementById("courseLevel").innerText =
          this.dataset.level || "N/A";
        document.getElementById("coursePrice").innerText =
          this.dataset.price || "0";
        document.getElementById("courseDiscount").innerText =
          this.dataset.discount || "0";
        document.getElementById("courseLanguage").innerText =
          this.dataset.language || "N/A";
        document.getElementById("courseCertificate").innerText =
          this.dataset.certificate || "No";
        document.getElementById("courseAssessment").innerText =
          this.dataset.assessment || "No";
        document.getElementById("courseSubscription").innerText =
          this.dataset.subscription || "No";
        $("#courseViewModal").modal("show");
      });
    });

    // EDIT functionality
    document.querySelectorAll(".edit-course").forEach(function (button) {
      button.addEventListener("click", function (e) {
        e.preventDefault();

        // Reset the arrays
        whatYouLearnItems = [];
        requirementsItems = [];
        whatYouLearnToDelete = [];
        requirementsToDelete = [];

        // Populate form fields
        document.getElementById("editCourseId").value = this.dataset.id;
        document.getElementById("editCourseTitle").value =
          this.dataset.title || "";
        document.getElementById("editCourseCategory").value =
          this.dataset.category || "";
        document.getElementById("editCourseLevel").value =
          this.dataset.level || "";
        document.getElementById("editCourseAuthor").value =
          this.dataset.author || "";
        document.getElementById("editCourseLanguage").value =
          this.dataset.language || "";
        document.getElementById("editCourseDescription").value =
          this.dataset.description || "";
        document.getElementById("editCoursePrice").value =
          this.dataset.price || "0";
        document.getElementById("editCourseDiscount").value =
          this.dataset.discount || "0";
        document.getElementById("editCourseDeadline").value =
          this.dataset.deadline || "";
        document.getElementById("editCourseStatus").value =
          this.dataset.status || "DRAFT";
        document.getElementById("editCourseCertificate").value =
          this.dataset.certificate || "No";
        document.getElementById("editCourseAssessment").value =
          this.dataset.assessment || "No";
        document.getElementById("editCourseSubscription").value =
          this.dataset.subscription || "False";
        document.getElementById("editCourseVideo").value =
          this.dataset.featuredvideo || "";

        // Set featured image preview if available
        var featuredImageUrl = this.dataset.featuredimage || "";
        var featuredImagePreview = document.getElementById(
          "featuredImagePreview"
        );
        if (featuredImageUrl) {
          featuredImagePreview.src = featuredImageUrl;
          featuredImagePreview.style.display = "block";
        } else {
          featuredImagePreview.src = "";
          featuredImagePreview.style.display = "none";
        }

        // Set certificate template preview if available
        var templateUrl = this.dataset.template || "";
        var templatePreview = document.getElementById("templatePreview");
        if (templateUrl) {
          templatePreview.src = templateUrl;
          templatePreview.style.display = "block";
        } else {
          templatePreview.src = "";
          templatePreview.style.display = "none";
        }

        // Populate What You Learn from data attribute
        let whatYouLearnRaw = this.dataset.whatyoulearn || "[]";
        try {
          whatYouLearnItems = JSON.parse(whatYouLearnRaw);
          if (!Array.isArray(whatYouLearnItems)) whatYouLearnItems = [];
        } catch (e) {
          console.error("Error parsing What You Learn:", e);
          whatYouLearnItems = [];
        }
        renderWhatYouLearn();

        // Populate Requirements from data attribute
        let requirementsRaw = this.dataset.requirements || "[]";
        try {
          requirementsItems = JSON.parse(requirementsRaw);
          if (!Array.isArray(requirementsItems)) requirementsItems = [];
        } catch (e) {
          console.error("Error parsing Requirements:", e);
          requirementsItems = [];
        }
        renderRequirements();

        // Clear the input fields
        document.getElementById("whatYouLearnInput").value = "";
        document.getElementById("requirementsInput").value = "";

        $("#courseEditModal").modal("show");
      });
    });

    // Listen for changes in editable inputs and update arrays
    document.addEventListener("input", function (e) {
      if (e.target.classList.contains("what-you-learn-edit")) {
        const idx = parseInt(e.target.getAttribute("data-idx"));
        whatYouLearnItems[idx] = e.target.value;
        // Update hidden field
        const filtered = whatYouLearnItems.filter(
          (_, i) => !whatYouLearnToDelete.includes(i)
        );
        document.getElementById("whatYouLearnHidden").value =
          JSON.stringify(filtered);
      }
      if (e.target.classList.contains("requirement-edit")) {
        const idx = parseInt(e.target.getAttribute("data-idx"));
        requirementsItems[idx] = e.target.value;
        // Update hidden field
        const filtered = requirementsItems.filter(
          (_, i) => !requirementsToDelete.includes(i)
        );
        document.getElementById("requirementsHidden").value =
          JSON.stringify(filtered);
      }
    });

    // Ensure hidden fields are updated before submitting the form
    document
      .getElementById("editCourseForm")
      .addEventListener("submit", function (e) {
        // Before filtering, update arrays from any edited input fields
        document
          .querySelectorAll(".what-you-learn-edit")
          .forEach(function (input) {
            const idx = parseInt(input.getAttribute("data-idx"));
            whatYouLearnItems[idx] = input.value;
          });
        document
          .querySelectorAll(".requirement-edit")
          .forEach(function (input) {
            const idx = parseInt(input.getAttribute("data-idx"));
            requirementsItems[idx] = input.value;
          });
        // Remove marked-for-deletion items before submit
        const filteredWhatYouLearn = whatYouLearnItems.filter(
          (_, idx) => !whatYouLearnToDelete.includes(idx)
        );
        const filteredRequirements = requirementsItems.filter(
          (_, idx) => !requirementsToDelete.includes(idx)
        );
        document.getElementById("whatYouLearnHidden").value =
          JSON.stringify(filteredWhatYouLearn);
        document.getElementById("requirementsHidden").value =
          JSON.stringify(filteredRequirements);
        // Optionally, clear the arrays after submit
        whatYouLearnToDelete = [];
        requirementsToDelete = [];
      });

    // DELETE functionality
    let courseIdToDelete = null;
    document.querySelectorAll(".delete-course").forEach(function (button) {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        courseIdToDelete = this.dataset.id;
        $("#deleteCourseModal").modal("show");
      });
    });

    document
      .getElementById("confirmDeleteCourseBtn")
      .addEventListener("click", function () {
        if (courseIdToDelete) {
          document.getElementById("deleteCourseId").value = courseIdToDelete;
          document.getElementById("deleteCourseForm").submit();
        }
      });

    // Preview for Featured Image
    document
      .getElementById("editCourseFeaturedImage")
      .addEventListener("change", function (e) {
        const file = e.target.files[0];
        const preview = document.getElementById("featuredImagePreview");
        if (file) {
          const reader = new FileReader();
          reader.onload = function (ev) {
            preview.src = ev.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      });

    // Preview for Certificate Template
    document
      .getElementById("editCourseTemplate")
      .addEventListener("change", function (e) {
        const file = e.target.files[0];
        const preview = document.getElementById("templatePreview");
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (ev) {
            preview.src = ev.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      });

    // Clear previews when modal is closed
    $("#courseEditModal").on("hidden.bs.modal", function () {
      whatYouLearnItems = [];
      requirementsItems = [];
      document.getElementById("whatYouLearnInput").value = "";
      document.getElementById("requirementsInput").value = "";
    });

    // Add Course Modal: What You Learn & Requirements logic
    function renderAddWhatYouLearn() {
      const list = document.getElementById("addWhatYouLearnList");
      list.innerHTML = "";
      addWhatYouLearnItems.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "input-group mb-2";
        div.innerHTML = `
          <input type="text" class="form-control add-what-you-learn-edit" data-idx="${idx}" value="${item.replace(/"/g, "&quot;")}">
          <div class="input-group-append">
            <button type="button" class="btn btn-danger btn-sm remove-add-what-you-learn" data-idx="${idx}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
      document.getElementById("addWhatYouLearnHidden").value = JSON.stringify(addWhatYouLearnItems);

      // Always show an empty input at the end for new entry
      const newDiv = document.createElement("div");
      newDiv.className = "input-group mb-2";
      newDiv.innerHTML = `
        <input type="text" class="form-control add-what-you-learn-new" placeholder="Add what you learn...">
        <div class="input-group-append">
          <button type="button" class="btn btn-success add-what-you-learn-btn-dynamic">
            <i class="fa fa-plus"></i> Add
          </button>
        </div>
      `;
      list.appendChild(newDiv);
    }

    function renderAddRequirements() {
      const list = document.getElementById("addRequirementsList");
      list.innerHTML = "";
      addRequirementsItems.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "input-group mb-2";
        div.innerHTML = `
          <input type="text" class="form-control add-requirement-edit" data-idx="${idx}" value="${item.replace(/"/g, "&quot;")}">
          <div class="input-group-append">
            <button type="button" class="btn btn-danger btn-sm remove-add-requirement" data-idx="${idx}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
      document.getElementById("addRequirementsHidden").value = JSON.stringify(addRequirementsItems);

      // Always show an empty input at the end for new entry
      const newDiv = document.createElement("div");
      newDiv.className = "input-group mb-2";
      newDiv.innerHTML = `
        <input type="text" class="form-control add-requirement-new" placeholder="Add requirement...">
        <div class="input-group-append">
          <button type="button" class="btn btn-success add-requirement-btn-dynamic">
            <i class="fa fa-plus"></i> Add
          </button>
        </div>
      `;
      list.appendChild(newDiv);
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Add What You Learn
      document.getElementById("addWhatYouLearnBtnAdd").addEventListener("click", function () {
        const input = document.getElementById("addWhatYouLearnInput");
        const value = input.value.trim();
        if (value) {
          addWhatYouLearnItems.push(value);
          input.value = "";
          renderAddWhatYouLearn();
        }
      });
      document.getElementById("addWhatYouLearnInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("addWhatYouLearnBtnAdd").click();
        }
      });
      document.getElementById("addWhatYouLearnList").addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-add-what-you-learn") || e.target.closest(".remove-add-what-you-learn")) {
          const button = e.target.classList.contains("remove-add-what-you-learn")
            ? e.target
            : e.target.closest(".remove-add-what-you-learn");
          const idx = parseInt(button.getAttribute("data-idx"));
          addWhatYouLearnItems.splice(idx, 1);
          renderAddWhatYouLearn();
        }
      });
      document.getElementById("addWhatYouLearnList").addEventListener("input", function (e) {
        if (e.target.classList.contains("add-what-you-learn-edit")) {
          const idx = parseInt(e.target.getAttribute("data-idx"));
          addWhatYouLearnItems[idx] = e.target.value;
          document.getElementById("addWhatYouLearnHidden").value = JSON.stringify(addWhatYouLearnItems);
        }
      });

      // Add Requirements
      document.getElementById("addRequirementsBtnAdd").addEventListener("click", function () {
        const input = document.getElementById("addRequirementsInput");
        const value = input.value.trim();
        if (value) {
          addRequirementsItems.push(value);
          input.value = "";
          renderAddRequirements();
        }
      });
      document.getElementById("addRequirementsInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("addRequirementsBtnAdd").click();
        }
      });
      document.getElementById("addRequirementsList").addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-add-requirement") || e.target.closest(".remove-add-requirement")) {
          const button = e.target.classList.contains("remove-add-requirement")
            ? e.target
            : e.target.closest(".remove-add-requirement");
          const idx = parseInt(button.getAttribute("data-idx"));
          addRequirementsItems.splice(idx, 1);
          renderAddRequirements();
        }
      });
      document.getElementById("addRequirementsList").addEventListener("input", function (e) {
        if (e.target.classList.contains("add-requirement-edit")) {
          const idx = parseInt(e.target.getAttribute("data-idx"));
          addRequirementsItems[idx] = e.target.value;
          document.getElementById("addRequirementsHidden").value = JSON.stringify(addRequirementsItems);
        }
      });

      // Dynamic add for What You Learn
      document.getElementById("addWhatYouLearnList").addEventListener("click", function (e) {
        const addBtn = e.target.closest(".add-what-you-learn-btn-dynamic");
        if (addBtn) {
          const input = addBtn.closest(".input-group").querySelector(".add-what-you-learn-new");
          if (!input) return;
          const value = input.value.trim();
          if (value) {
            addWhatYouLearnItems.push(value);
            renderAddWhatYouLearn();
          } else {
            input.focus();
          }
        }
        const removeBtn = e.target.closest(".remove-add-what-you-learn");
        if (removeBtn) {
          const idx = parseInt(removeBtn.getAttribute("data-idx"));
          addWhatYouLearnItems.splice(idx, 1);
          renderAddWhatYouLearn();
        }
      });
      document.getElementById("addWhatYouLearnList").addEventListener("keypress", function (e) {
        if (e.target.classList.contains("add-what-you-learn-new") && e.key === "Enter") {
          e.preventDefault();
          const btn = e.target.closest(".input-group").querySelector(".add-what-you-learn-btn-dynamic");
          if (btn) btn.click();
        }
      });
      document.getElementById("addWhatYouLearnList").addEventListener("input", function (e) {
        if (e.target.classList.contains("add-what-you-learn-edit")) {
          const idx = parseInt(e.target.getAttribute("data-idx"));
          addWhatYouLearnItems[idx] = e.target.value;
          document.getElementById("addWhatYouLearnHidden").value = JSON.stringify(addWhatYouLearnItems);
        }
      });

      // Dynamic add for Requirements
      document.getElementById("addRequirementsList").addEventListener("click", function (e) {
        const addBtn = e.target.closest(".add-requirement-btn-dynamic");
        if (addBtn) {
          const input = addBtn.closest(".input-group").querySelector(".add-requirement-new");
          if (!input) return;
          const value = input.value.trim();
          if (value) {
            addRequirementsItems.push(value);
            renderAddRequirements();
          } else {
            input.focus();
          }
        }
        const removeBtn = e.target.closest(".remove-add-requirement");
        if (removeBtn) {
          const idx = parseInt(removeBtn.getAttribute("data-idx"));
          addRequirementsItems.splice(idx, 1);
          renderAddRequirements();
        }
      });
      document.getElementById("addRequirementsList").addEventListener("keypress", function (e) {
        if (e.target.classList.contains("add-requirement-new") && e.key === "Enter") {
          e.preventDefault();
          const btn = e.target.closest(".input-group").querySelector(".add-requirement-btn-dynamic");
          if (btn) btn.click();
        }
      });
      document.getElementById("addRequirementsList").addEventListener("input", function (e) {
        if (e.target.classList.contains("add-requirement-edit")) {
          const idx = parseInt(e.target.getAttribute("data-idx"));
          addRequirementsItems[idx] = e.target.value;
          document.getElementById("addRequirementsHidden").value = JSON.stringify(addRequirementsItems);
        }
      });

      // Reset on modal close
      $('#addCourseModal').on('hidden.bs.modal', function () {
        addWhatYouLearnItems = [];
        addRequirementsItems = [];
        renderAddWhatYouLearn();
        renderAddRequirements();
      });
    });
  });
</script>

{% endblock %}
